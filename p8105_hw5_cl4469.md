p8105_hw5_cl4469
================
Chen Liang
2023-11-12

``` r
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.3     ✔ readr     2.1.4
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.0
    ## ✔ ggplot2   3.4.3     ✔ tibble    3.2.1
    ## ✔ lubridate 1.9.2     ✔ tidyr     1.3.0
    ## ✔ purrr     1.0.2     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "95%"
)

theme_set(theme_minimal() + theme(legend.position = 'bottom'))

options(
  ggplot2.continuous.colour = 'viridis',
  ggplot2.continuous.fill = 'viridis'
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Problem 1

``` r
homicide_df = read.csv("hw5_data/homicide-data.csv")
```

This dataset contains 52179 rows and 12 columns, with each row
resprenting a single event occurred. Variables include id,
reported-date, victims’last name,race, and sex. It contains the location
of the killing (city, state, latitude, longitude) and whether an arrest
was made. Moreover, there are some missing values in `lat` and `lon`
columns and unknown information in
`victim_last`,`victim_first`,`victim_age`,`victim_sex`, and
`victim_race`.

``` r
hom_summary = homicide_df|>
  mutate(
    city_state = str_c(city, state, sep = ","),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )) |>
  group_by(city_state) |>
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved"),
    home_solved = sum(resolved == "solved")
  )

hom_summary
```

    ## # A tibble: 51 × 4
    ##    city_state     hom_total hom_unsolved home_solved
    ##    <chr>              <int>        <int>       <int>
    ##  1 Albuquerque,NM       378          146         232
    ##  2 Atlanta,GA           973          373         600
    ##  3 Baltimore,MD        2827         1825        1002
    ##  4 Baton Rouge,LA       424          196         228
    ##  5 Birmingham,AL        800          347         453
    ##  6 Boston,MA            614          310         304
    ##  7 Buffalo,NY           521          319         202
    ##  8 Charlotte,NC         687          206         481
    ##  9 Chicago,IL          5535         4073        1462
    ## 10 Cincinnati,OH        694          309         385
    ## # ℹ 41 more rows

``` r
res_tidy = prop.test(
  hom_summary |>filter(city_state == "Baltimore,MD") |> pull(hom_unsolved), 
  hom_summary |>filter(city_state == "Baltimore,MD") |> pull(hom_total)) |>
  broom::tidy(res_tidy)

save(res_tidy, file = "result/prop_test_MD.RData")
```

Pull the estimated proportion and confidence intervals from the
resulting tidy dataframe

``` r
estimated_prop=pull(res_tidy, estimate)
ci=paste("(", pull(res_tidy, conf.low),",", pull(res_tidy, conf.high),")")
```

``` r
results_df = 
  hom_summary %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `prop_tests = map2(.x = hom_unsolved, .y = hom_total,
    ##   ~prop.test(x = .x, n = .y))`.
    ## Caused by warning in `prop.test()`:
    ## ! Chi-squared approximation may be incorrect

``` r
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

<img src="p8105_hw5_cl4469_files/figure-gfm/unnamed-chunk-4-1.png" width="95%" />

# Problem 2

First, we create a dataframe and read in data for each subject.

``` r
file_name =
  list.files("hw5_data/data/", full.names = TRUE)

prob2_df= file_name |>
  map_dfr(read_csv)|>
  bind_cols(name = file_name)
```

    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
    ## Rows: 1 Columns: 8
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (8): week_1, week_2, week_3, week_4, week_5, week_6, week_7, week_8
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

Next, we tidy the result.

``` r
tidy_prob2_df =
  prob2_df|> 
  mutate(arm = 
           case_when(
             str_detect(name, "con") ~ "control",
             str_detect(name, "exp") ~ "experimental"),
         id = str_sub(name, 20, 21)
         ) |>
  pivot_longer(week_1:week_8,
               names_to = "week",
               values_to = "observations",
               names_prefix = "week_") |> 
  mutate(week = as.numeric(week))|>
  dplyr::select(id, arm, week, observations)
```

Make a spaghetti plot showing observations on each subject over time.

``` r
tidy_prob2_df |>
  ggplot(aes(x = week, y = observations, color = id)) +
  geom_point()+
  geom_line() +
  facet_grid(~arm) +
  geom_smooth(aes(group = 1), se = FALSE, color = "red") +
  labs(x = 'Week', y = 'Observations', title = 'Spaghetti Plot of Observations on Each Subject Over Time')
```

    ## `geom_smooth()` using method = 'loess' and formula = 'y ~ x'

<img src="p8105_hw5_cl4469_files/figure-gfm/unnamed-chunk-7-1.png" width="95%" />

``` r
ggsave("result/Spaghetti Plot of Observations on Each Subject Over Time.pdf")
```

    ## Saving 6 x 3.6 in image
    ## `geom_smooth()` using method = 'loess' and formula = 'y ~ x'

Comment: From the spaghetti plot, the data values of the experimental
group seem to be generally greater than those of the control group. We
also observe a gentle variation in values over time within the control
arm, whereas the experimental arm consistently demonstrates higher
values than those in the control arm, with a tendency to increase over
time.

# Problem 3

Fix n=30 Fix σ=5

``` r
t_test = function(mu, n = 30, sigma = 5) {
  
  sim_data = tibble(
    x = rnorm(n, mean = mu, sd = sigma)
    )
  
  sim_result = broom::tidy(t.test(sim_data))
  sim_result |> 
    dplyr::select(estimate, p.value)
}

sim_results_df = 
  expand_grid(
    mu = 0,
    iter = 1:5000
    )|>
  mutate(
    estimate_df = map(mu, t_test)
    ) |> 
  unnest(estimate_df) |>
  rename("p_value" = "p.value")

sim_results_df
```

    ## # A tibble: 5,000 × 4
    ##       mu  iter estimate p_value
    ##    <dbl> <int>    <dbl>   <dbl>
    ##  1     0     1   -1.28   0.0753
    ##  2     0     2    1.22   0.220 
    ##  3     0     3   -1.11   0.261 
    ##  4     0     4    0.729  0.469 
    ##  5     0     5    0.177  0.865 
    ##  6     0     6   -1.52   0.0899
    ##  7     0     7    0.334  0.739 
    ##  8     0     8   -0.330  0.764 
    ##  9     0     9   -0.626  0.433 
    ## 10     0    10    0.160  0.831 
    ## # ℹ 4,990 more rows

Repeat the above for mu=1,2,3,4,5,6, and complete the following:

``` r
new_results_df = 
  expand_grid(
    mu = c(1,2,3,4,5,6),
    iter = 1:5000
  ) |> 
  mutate(
    estimate_df = map(mu, t_test)
  ) |> 
  unnest(estimate_df) |>
  rename("p_value" = "p.value")
```

Make a plot showing the proportion of times the null was rejected (the
power of the test) on the y axis and the true value of μ on the x axis

``` r
all_result_df= bind_rows(sim_results_df, new_results_df)

power_df =
  all_result_df |> 
  mutate(reject = case_when(
    p_value > 0.05 ~ FALSE,
    p_value < 0.05 ~ TRUE
  )) |> 
  group_by(mu) |> 
  summarise(count = sum(reject)) |> 
  mutate(prop_rejext = count / 5000)

power_df |> 
  ggplot(aes(x = mu, y = prop_rejext)) +
  geom_point() +
  geom_line() +
  labs(title = "Proportiobn of Rejected Hypotheses for each Mu",
       x = "True Value of Mu", y = "Proportion Rejected")
```

<img src="p8105_hw5_cl4469_files/figure-gfm/unnamed-chunk-10-1.png" width="95%" />
